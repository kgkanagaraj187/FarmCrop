/*! kmaps-gl - v0.0.0
 *  Release on: 2016-06-13
 *  Copyright (c) 2016 KoalaMaps
 *  Licensed Commercial 
 *  Major refactoring 2019-09-26 by Geocledian
 * */
"use strict";function HttpClient(){this.get=function(t,e){console.debug("URL: "+t);var n=new XMLHttpRequest;n.onreadystatechange=function(){4===n.readyState&&200===n.status&&e(n.responseText)},n.open("GET",t,!0),n.send(null)}}function KMaps(t){var e,n,a,i,o=new HttpClient,r=document.getElementById(t.mapControlId),s=new Spinner({color:"#000000",lines:12});s.spin(r);var l={autoPlay:!0,autoPlayDelay:1e3,preloadImages:!0};_.each(["parcelId","autoPlay","autoPlayDelay","products","productKey","accessToken","preloadImages","hostURL","wmts_provider"],function(t){if(r.hasAttribute(t)){var e=r.getAttribute(t),n=parseInt(e),a=e.split(",");isNaN(n)?"true"===e.toLowerCase()?l[t]=!0:"false"===e.toLowerCase()?l[t]=!1:a.length>1?l[t]=a:l[t]=e:l[t]=e}}),(t=_.extend(t,l)).currentImageOverlay=null,t.imageOverlays=Object.create(null);var d=new Widget(t.mapControlId).build(widget,r);o.get(PARCEL_PRODUCT_URL.format({hostURL:t.hostURL,parcelId:t.parcelId,productKey:t.productKey,accessToken:t.accessToken}),function(l){var u=JSON.parse(l),p=u.content[0].bounds;o.get(PARCEL_URL.format({hostURL:t.hostURL,parcelId:t.parcelId,accessKey:t.accessToken}),function(o){var s=JSON.parse(o).content[0],l=s.geometry.coordinates,h=s.centroid.coordinates,g=(new Date).getTime(),m=new Date(s.enddate).getTime(),f=g;(g>m?(!1,f=m):m>=g&&(f=g),i=L.map(t.mapControlId+"map").setView([h[1],h[0]],11),L.tileLayer.provider(t.provider||"OpenStreetMap").addTo(i),t.wmts_provider)?new L.tileLayer(t.wmts_provider,{attribution:"&copy;"}).addTo(i):L.tileLayer.provider(t.provider||"OpenStreetMap").addTo(i);var y=[];Array.prototype.forEach.call(l[0],function(t){var e=[];Array.prototype.forEach.call(t,function(t){e.push([t[1],t[0]])}),y.push(e)}),L.multiPolyline(y,{color:"red"}).addTo(i);a=new window.Clock(function(t){e.setCustomTime(new Date(t),"now")},{speed:1e5*t.autoPlayDelay,tickLen:MS_IN_A_DAY,start:new Date(s.startdate).getTime(),end:f,stop:m,mapControlId:t.mapControlId}),i.addControl(new InfoControl(a,s)),i.addControl(new DateControl(a));var v={width:"100%",height:"100%",type:"box",clickToUse:!1,selectable:!1,editable:!1,moveable:!0,stack:!1,orientation:"bottom",showMajorLabels:!1,showMinorLabels:!0,snap:function(t,e,n){return Math.round(t/MS_IN_A_DAY)*MS_IN_A_DAY}};n=new vis.DataSet,new vis.DataSet([{id:1,content:"General",value:1},{id:0,content:"Special",value:3},{id:2,content:"Most special",value:2}]),n.add([{id:1,start:s.startdate,type:"point",className:"start",group:1},{id:2,start:s.planting,type:"point",className:"planting",group:1},{id:3,start:s.harvest,type:"point",className:"harvest",title:s.harvest,group:1},{id:4,start:g,type:"point",className:"today",group:1},{id:5,start:s.enddate,type:"point",className:"end",group:1}]),n.add(_.map(u.content,function(t,e){return{id:e+6,start:t.date,type:"point",className:"special",title:t.date,group:1}}));for(var w=u.content.length+10,D=a.getDates(s.startdate,s.enddate),T=0;T<D.length;T+=1)n.add([{id:w,start:D[T],type:"point",className:"otherdays",title:D[T].simpleDate(),group:0}]),w+=1;e=new vis.Timeline(r.querySelector(".timeline"),n,v);var C,b=new Date(s.startdate).getTime(),k=new Date(s.enddate).getTime(),I=(k-b)/50;if(e.setWindow(b-I,k+I),e.addCustomTime(new Date(s.startdate),"now",{color:"red"}),C=r.querySelector(".productKey"),_.each(t.products,function(t){var e=document.createElement("option");e.value=t,e.appendChild(document.createTextNode(t)),C.appendChild(e)}),function(e){var n={select:{change:function(e){t.productKey=e.target.value,a.setCursor(a.getTime()-MS_IN_A_DAY)}},".step_backward":{click:function(t){a.setCursor(a.getTime()-MS_IN_A_DAY)},dblclick:function(t){return t.stopPropagation(),t.preventDefault(),!1}},".step_forward":{click:function(t){a.setCursor(a.getTime()+MS_IN_A_DAY),t.stopPropagation()},dblclick:function(t){return t.stopPropagation(),t.preventDefault(),!1}},".play_pause":{click:function(t){a.isPlaying()?a.stop():a.start(),t.stopPropagation(),t.preventDefault()},dblclick:function(t){return t.stopPropagation(),t.preventDefault(),!1}},".timeline":{mouseover:function(t){r.querySelector(".hintDate")}}};for(var i in n){var o=e.querySelector(i);if(o)for(var s in n[i])o.addEventListener(s,n[i][s])}}(d),a.onstart=function(t){var e=r.querySelector(".fa-play");e&&e.setAttribute("class",e.getAttribute("class").replace(/fa-play/gi,"fa-pause"))},a.onstop=function(t){var e=r.querySelector(".fa-pause");e&&e.setAttribute("class",e.getAttribute("class").replace(/fa-pause/gi,"fa-play"))},a.addCallback(function(e){var n=PARCEL_PRODUCT_DATE_URL.format({attribution:'Imagery Â© <a href="http://www.koalamaps.com">Koalamaps</a>',hostURL:t.hostURL,parcelId:t.parcelId,date:new Date(e).simpleDate().replace(/-/gi,""),productKey:t.productKey,accessToken:t.accessToken}),a=new Date(e).simpleDate().replace(/-/gi,""),o=t.parcelId+"_"+t.productKey+"_"+a;t.imageOverlays[o]?(t.currentImageOverlay=t.imageOverlays[o],t.currentImageOverlay.bringToFront()):(t.imageOverlays[o]=L.imageOverlay(n,p),t.currentImageOverlay=t.imageOverlays[o],i.addLayer(t.currentImageOverlay),i.fitBounds(p),t.currentImageOverlay.bringToFront())}),t.autoPlay?a.start():a.setCursor(new Date(s.startdate).getTime()),t.preloadImages)for(var A=0;A<t.products.length;A+=1)for(var S=0;S<D.length;S+=1){var U=PARCEL_PRODUCT_DATE_URL.format({hostURL:t.hostURL,parcelId:t.parcelId,date:D[S].simpleDate().replace(/-/gi,""),productKey:t.products[A],accessToken:t.accessToken}),O=D[S].simpleDate().replace(/-/gi,""),R=t.parcelId+"_"+t.products[A]+"_"+O;t.imageOverlays[R]=L.imageOverlay(U,p),i.addLayer(t.imageOverlays[R]),t.imageOverlays[R].bringToBack()}e.on("timechange",function(t){if(t.time.getTime()<new Date(s.startdate).getTime()||t.time.getTime()>new Date(s.enddate).getTime()){if(t.time.getTime()<new Date(s.startdate).getTime()&&c.setCursor(new Date(s.startdate).getTime()),t.time.getTime()>new Date(s.enddate).getTime()&&a.isPlaying()){a.setCursor(new Date(s.enddate).getTime());var e=r.querySelector(".fa-pause");e&&e.setAttribute("class",e.getAttribute("class").replace(/fa-pause/gi,"fa-play"))}}else a.setCursor(t.time.getTime())}),e.on("click",function(t){a.setCursor(t.time.getTime())}),e.on("select",function(t){var n=e.itemsData._data[t.items[0]];console.log(n)}),i.addControl(new CustomBtn({position:"topright",icon:"fa-question-circle",helpUrl:"http://www.geocledian.com",style:{cursor:"hand"}})),i.addControl(new CustomBtn({position:"bottomright",icon:"gl-logo",helpUrl:"http://www.geocledian.com",style:{width:150,height:50,cursor:"hand"}}))}),s.stop()}),this.getTimeLineObj=function(){return e},this.getTime=function(){return a.getTime()},this.setTime=function(t){a.setCursor(t)},this.getStartTime=function(){return a.getStartTime()},this.getEndTime=function(){return a.getEndTime()},this.getParcelId=function(){return t.parcelId},this.getProperties=function(){return t},this.getWidget=function(){return d},this.getMap=function(){return i},this.destroy=function(){i.remove(),a.stop(),a=null;let e=document.getElementById(t.mapControlId);for(console.debug(e);e.firstChild;)e.removeChild(e.firstChild);t=Object.create(null),o=null,d=null},this.startVideo=function(){a.start()},this.stopVideo=function(){a.stop()}}function Widget(t){var e=this;return e.prefix=t,{build:function(t,n){var a=document.createElement(t._tag);for(var i in t)"_"!==i[0]&&("id"===i?a.setAttribute(i,e.prefix+t[i]):a.setAttribute(i,t[i]));return _.each(t._childs,function(t){new Widget(e.prefix).build(t,a)}),n&&n.appendChild(a),a}}}window.Clock=L.Class.extend({initialize:function(t,e){this._callbacksArry=[],t&&this.addCallback(t),L.setOptions(this,e),this._speed=this.options.speed,this._tickLen=this.options.tickLen,this._cursor=this.options.start,this._transitionTime=this._tickLen/this._speed},_tick:function(t){if(t._cursor>t.getEndTime()){if(clearInterval(t._intervalID),t.isPlaying()){var e=document.getElementById(t.getMapControlid()).querySelector(".fa-pause");e&&e.setAttribute("class",e.getAttribute("class").replace(/fa-pause/gi,"fa-play"))}}else t._callbacks(t._cursor),t._cursor+=t._tickLen},_callbacks:function(t){for(var e=this._callbacksArry,n=e.length,a=0;n>a;a+=1)e[a](t)},addCallback:function(t){this._callbacksArry.push(t)},start:function(){this._intervalID||(this._cursor>this.getEndTime()&&this.setCursor(this.getStartTime()),this._intervalID=window.setInterval(this._tick,this._transitionTime,this),this.onstart&&this.onstart(this._cursor))},stop:function(){this._intervalID&&(clearInterval(this._intervalID),this._intervalID=null,this.onstop&&this.onstop(this._cursor))},getSpeed:function(){return this._speed},isPlaying:function(){return!!this._intervalID},setSpeed:function(t){this._speed=t,this._transitionTime=this._tickLen/t,this._intervalID&&(this.stop(),this.start())},setCursor:function(t){var e=parseInt(t);if(e){var n=e%this._tickLen;0!==n&&(e+=this._tickLen-n),this._cursor=e,this._callbacks(this._cursor)}},getTime:function(){return this._cursor},getStartTime:function(){return this.options.start},getMapControlid:function(){return this.options.mapControlId},getEndTime:function(){return this.options.end},getStopTime:function(){return this.options.stop},getTickLen:function(){return this._tickLen},getDates:function(t,e){for(var n=new Date(t),a=new Date(e),i=[],o=n;a>=o;)i.push(o),o=o.addDays(1);return i}}),Date.prototype.addDays=function(t){var e=new Date(this.valueOf());return e.setDate(e.getDate()+t),e},window.BASE_URL="{hostURL}",window.PARCEL_URL=window.BASE_URL+"/{parcelId}?key={accessKey}&geoformat=GEOJSON",window.PARCEL_PRODUCT_URL=window.BASE_URL+"/{parcelId}/{productKey}?key={accessToken}&geoformat=GEOJSON",window.PARCEL_PRODUCT_DATE_URL=window.BASE_URL+"/{parcelId}/{productKey}/date/{date}.png?key={accessToken}",window.MS_IN_A_DAY=864e5,Date.prototype.simpleDate=function(){var t=this.getFullYear(),e=this.getMonth()+1,n=this.getDate();return t+"-"+(1===e.toString().length?"0"+e:e)+"-"+(1===n.toString().length?"0"+n:n)},String.prototype.format=function(t){var e=this;for(var n in t){var a=new RegExp("\\{"+n+"\\}","gi");e=e.replace(a,t[n])}return e},String.prototype.splice=function(t,e,n){return this.slice(0,t)+n+this.slice(t+Math.abs(e))},window.widget={_tag:"div",_childs:[{_tag:"div",id:"map"},{_tag:"div",class:"timeline"},{_tag:"div",class:"hintDate",style:"position:absolute;display:none;background-color:black;color:white;"}]},window.controlWidgetArray={_tag:"div",style:"-moz-user-select: none; -webkit-user-select: none; -ms-user-select:none; user-select:none;-o-user-select:none;",unselectable:"on",onselectstart:"return false;",_childs:[{_tag:"ul",class:"nav",_childs:[{_tag:"li",class:"btn play_pause",_childs:[{_tag:"i",class:"fa fa-play"}]}]},{_tag:"select",class:"productKey"}]},window.DateControl=L.Control.extend({options:{position:"bottomleft"},initialize:function(t,e){L.setOptions(this,e),this.clock=t},onAdd:function(t){this._container=L.DomUtil.create("div","leaflet-control-layers leaflet-control-layers-expanded date-control");return this.clock.getTime(),(new Widget).build(window.controlWidgetArray,this._container),this._container}}),window.infoControlWidgetArray={_tag:"div",style:"-moz-user-select: none; -webkit-user-select: none; -ms-user-select:none; user-select:none;-o-user-select:none;",unselectable:"on",onselectstart:"return false;",_childs:[{_tag:"ul",class:"nav",_childs:[{_tag:"li",class:"btn play_pause",_childs:[{_tag:"i",class:"fa fa-play"}]}]},{_tag:"select",class:"productKey"}]},window.InfoControl=L.Control.extend({options:{position:"bottomleft"},initialize:function(t,e,n){L.setOptions(this,n),this.clock=t,this.content=e},onAdd:function(t){this._container=L.DomUtil.create("div","leaflet-control-layers leaflet-control-layers-expanded info-control");var e=this,n=(e.clock.getTime(),L.DomUtil.create("div","nameControl",this._container));this._name=L.DomUtil.create("p","",n),this._name.innerHTML=e.content.name;var a=L.DomUtil.create("div","cropnameControl",this._container);this._cropname=L.DomUtil.create("p","",a),this._cropname.innerHTML=", "+e.content.crop;var i=L.DomUtil.create("div","areaControl",this._container);return this._area=L.DomUtil.create("p","",i),this._area.innerHTML=", "+e.content.area+" ha",e.clock.addCallback(function(t){}),this._container}}),window.CustomBtn=L.Control.extend({options:{position:"topright"},onAdd:function(){var t,e=this;return 0===this.options.icon.indexOf("http")?((t=L.DomUtil.create("img")).src=this.options.icon,function(t,e){if("string"==typeof e)t.setAttribute("style",e);else if("object"==typeof e)for(var n in e)t.style[n]=e[n]}(t,this.options.style)):t=L.DomUtil.create("i","fa w3-large "+this.options.icon),t.onclick=function(){window.open(e.options.helpUrl,"_blank")},t}});